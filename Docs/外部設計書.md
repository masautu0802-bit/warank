# 外部設計書

## 1. システム構成

### 1.1 アーキテクチャ
- **フロントエンド**: Next.js 16 (App Router)
- **レンダリング**: Server Components + Client Components
- **バックエンド**: Supabase（BaaS）
- **認証**: Supabase Auth
- **データベース**: PostgreSQL（Supabase）

### 1.2 技術スタック
```
フロントエンド:
  - Next.js 16.1.2 (App Router)
  - React 19.2.3
  - TypeScript 5.x
  - Tailwind CSS 4.x
  - shadcn/ui (優先使用)
  - anime.js 4.2.2 (アニメーション)
  - Recharts 3.6.0 (グラフ)

バックエンド:
  - Supabase JS Client (@supabase/ssr)
  - PostgreSQL（Supabase管理）

その他:
  - Google Gemini API 1.34.0（AI解説機能）
  - html2canvas 1.4.1（画像生成）
```

## 2. 画面設計

### 2.1 画面一覧

| 画面ID | 画面名 | URL | 認証要否 | コンポーネント種別 |
|--------|--------|-----|----------|-------------------|
| HOME | ホーム | `/` | 不要 | Server Component |
| COMEDIAN_DETAIL | 芸人詳細 | `/comedian/[id]` | 不要 | Server Component |
| EVENT_DETAIL | イベント詳細 | `/event/[id]` | 不要 | Server Component |
| ALL_RANKINGS | 全ランキング | `/rankings` | 不要 | Server Component |
| EVENTS | イベント一覧 | `/events` | 不要 | Server Component |
| PREDICTIONS | 予想一覧 | `/predictions` | 要 | Server Component |
| PREDICTION_ANALYSIS | 予想分析 | `/prediction-analysis` | 要 | Server Component |
| LOGIN | ログイン | `/login` | 不要 | Server Component |
| PROFILE | プロフィール | `/profile` | 要 | Server Component |

**注意**: 各ページはServer Componentとして実装し、インタラクティブな機能はClient Componentとして`components/`フォルダに配置

### 2.2 画面遷移図

```
[ホーム] ──→ [芸人詳細]
    │            │
    ├──→ [イベント詳細]
    │            │
    ├──→ [全ランキング]
    │
    ├──→ [イベント一覧]
    │
    ├──→ [予想一覧] ──→ [イベント詳細（予想タブ）]
    │
    ├──→ [ログイン] ──→ [プロフィール]
    │
    └──→ [予想分析]
```

### 2.3 主要画面の詳細設計

#### 2.3.1 ホーム画面（HOME）

**レイアウト**:
```
┌─────────────────────────────────────────┐
│             ヘッダー                      │
├──────────────────┬──────────────────────┤
│                  │                      │
│  日付スライダー   │                      │
│                  │                      │
│  イベント一覧     │   ランキングサイドバー │
│  （左カラム）     │   （右カラム）        │
│                  │                      │
│  主要4大会       │                      │
│                  │                      │
└──────────────────┴──────────────────────┘
```

**機能**:
- 日付スライダーによる日付選択
- 選択日付のイベント一覧表示
- ティアフィルタリング
- 主要4大会フィルタリング
- ランキングサイドバー（上位10名）
- モバイル: タブ切り替え（その日の公演 / 主要4大会）

**コンポーネント**:
- `app/page.tsx`: ホームページ（Server Component）
- `components/features/home/HomePageClient.tsx`: ホームページクライアント（Client Component）
- `components/features/home/DateSlider.tsx`: 日付スライダー（Client Component - 'use client'）
- `components/features/event/EventList.tsx`: イベント一覧（Client Component - 'use client'）
- `components/features/ranking/RankingSidebar.tsx`: ランキングサイドバー（Client Component - 'use client'）
- `components/features/event/Major4Tournaments.tsx`: 主要4大会（Client Component - 'use client'）
- `components/ui/button.tsx`: ボタン（shadcn/ui）
- `components/ui/slider.tsx`: スライダー（shadcn/ui）

#### 2.3.2 芸人詳細画面（COMEDIAN_DETAIL）

**レイアウト**:
```
┌─────────────────────────────────────────┐
│             ヘッダー                      │
├─────────────────────────────────────────┤
│         芸人プロフィールヘッダー           │
│  [画像] [名前] [ランク] [ポイント]       │
├─────────────────────────────────────────┤
│  タブナビゲーション                      │
│  [メトリクス] [実績] [予定] [分析]       │
├─────────────────────────────────────────┤
│                                         │
│  タブコンテンツ                          │
│                                         │
└─────────────────────────────────────────┘
```

**タブ内容**:
- **メトリクス**: ランキング、総ポイント、属性値（5つの能力値）
- **実績**: 3位以内の大会成績（トロフィー棚）、パフォーマンス履歴
- **予定**: 今後の出演予定
- **分析**: ランキング推移グラフ

**コンポーネント**:
- `app/comedian/[id]/page.tsx`: 芸人詳細ページ（Server Component）
- `components/features/comedian/ComedianDetailClient.tsx`: 芸人詳細クライアント（Client Component - 'use client'）
- `components/features/comedian/RankingTransitionChart.tsx`: ランキング推移グラフ（Client Component - 'use client'）
- `components/features/comedian/FavoriteButton.tsx`: お気に入りボタン（Client Component - 'use client'）
- `components/ui/tabs.tsx`: タブ（shadcn/ui）

#### 2.3.3 イベント詳細画面（EVENT_DETAIL）

**レイアウト**:
```
┌─────────────────────────────────────────┐
│             ヘッダー                      │
├─────────────────────────────────────────┤
│         イベント基本情報                  │
│  [画像] [名前] [日付] [ティア]           │
├─────────────────────────────────────────┤
│  タブナビゲーション                      │
│  [概要] [参加芸人] [予想]                │
├─────────────────────────────────────────┤
│                                         │
│  タブコンテンツ                          │
│                                         │
└─────────────────────────────────────────┘
```

**タブ内容**:
- **概要**: イベント詳細情報、ブロック別対戦結果
- **参加芸人**: 参加芸人一覧と順位
- **予想**: 予想入力・編集・結果表示

**コンポーネント**:
- `app/event/[id]/page.tsx`: イベント詳細ページ（Server Component）
- `components/features/event/EventDetailClient.tsx`: イベント詳細クライアント（Client Component - 'use client'）
- `components/features/prediction/PredictionInput.tsx`: 予想入力フォーム（Client Component - 'use client'）
- `components/features/prediction/PredictionResultDisplay.tsx`: 予想結果表示（Client Component - 'use client'）
- `components/features/event/BlockResults.tsx`: ブロック別対戦結果（Client Component - 'use client'）
- `components/ui/form.tsx`: フォーム（shadcn/ui）
- `components/ui/input.tsx`: 入力（shadcn/ui）

#### 2.3.4 予想一覧画面（PREDICTIONS）

**レイアウト**:
```
┌─────────────────────────────────────────┐
│             ヘッダー                      │
├─────────────────────────────────────────┤
│  予想一覧ヘッダー                        │
│  [M-1] [R-1] [THE SECOND] [キングオブコント]│
├─────────────────────────────────────────┤
│                                         │
│  ブランドごとのイベントカードグリッド      │
│                                         │
└─────────────────────────────────────────┘
```

**機能**:
- ブランドごとにグループ化されたイベント表示
- イベントカードに予想状況を表示
- 開催前/開催中/終了のステータス表示
- 予想結果のプレビュー

**コンポーネント**:
- `app/predictions/page.tsx`: 予想一覧ページ（Server Component）
- `components/features/predictions/PredictionsPageClient.tsx`: 予想一覧クライアント（Client Component - 'use client'）
- `components/features/event/EventCard.tsx`: イベントカード（予想用）（Client Component - 'use client'）
- `components/ui/card.tsx`: カード（shadcn/ui）

#### 2.3.5 ログイン画面（LOGIN）

**レイアウト**:
```
┌─────────────────────────────────────────┐
│             ヘッダー                      │
├─────────────────────────────────────────┤
│                                         │
│         ログインフォーム                 │
│  [メールアドレス]                       │
│  [パスワード]                           │
│  [ログインボタン]                       │
│  [新規登録リンク]                       │
│                                         │
└─────────────────────────────────────────┘
```

**機能**:
- メール/パスワードによるログイン
- 新規登録へのリンク
- パスワードリセットリンク

## 3. API設計

### 3.1 Supabase API

#### 3.1.1 データ取得API

**芸人データ取得**
```typescript
supabase
  .from('comedians')
  .select('*')
```

**イベントデータ取得**
```typescript
supabase
  .from('events')
  .select('*')
  .order('date', { ascending: true })
```

**パフォーマンスデータ取得**
```typescript
supabase
  .from('performances')
  .select('*')
  .order('rank', { ascending: true, nullsFirst: false })
```

#### 3.1.2 認証API

**ユーザー登録**
```typescript
supabase.auth.signUp({
  email: string,
  password: string
})
```

**ログイン**
```typescript
supabase.auth.signInWithPassword({
  email: string,
  password: string
})
```

**ログアウト**
```typescript
supabase.auth.signOut()
```

**パスワードリセット**
```typescript
supabase.auth.resetPasswordForEmail(email, {
  redirectTo: string
})
```

#### 3.1.3 予想データAPI

**予想データ取得**
```typescript
supabase
  .from('event_predictions')
  .select('*')
  .eq('user_id', userId)
```

**予想データ保存**
```typescript
supabase
  .from('event_predictions')
  .upsert({
    event_id: string,
    user_id: string,
    predictions: PredictionEntry[],
    total_bet_points: number,
    paid_out: boolean
  })
```

**予想データ削除**
```typescript
supabase
  .from('event_predictions')
  .delete()
  .eq('event_id', eventId)
  .eq('user_id', userId)
```

#### 3.1.4 お気に入りAPI

**お気に入り取得**
```typescript
supabase
  .from('user_favorites')
  .select('*')
  .eq('user_id', userId)
```

**お気に入り追加**
```typescript
supabase
  .from('user_favorites')
  .insert({
    user_id: string,
    type: 'comedian' | 'event',
    target_id: string
  })
```

**お気に入り削除**
```typescript
supabase
  .from('user_favorites')
  .delete()
  .eq('user_id', userId)
  .eq('type', type)
  .eq('target_id', targetId)
```

### 3.2 外部API

#### 3.2.1 Google Gemini API
- **用途**: AI解説機能
- **エンドポイント**: `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent`
- **認証**: API Key

## 4. データベース設計

### 4.1 テーブル一覧

| テーブル名 | 説明 |
|-----------|------|
| comedians | 芸人情報 |
| events | イベント情報 |
| performances | パフォーマンス情報 |
| event_predictions | 予想データ |
| user_profiles | ユーザープロフィール |
| user_favorites | お気に入り |
| user_preferences | ユーザー設定 |

### 4.2 テーブル定義

#### 4.2.1 comedians

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | text | PK | 芸人ID |
| name | text | NOT NULL | 芸人名 |
| image_url | text | | 画像URL |
| agency | text | | 所属事務所 |
| trend | text | | トレンド（up/down/stable） |
| cheer_count | integer | | 応援数 |
| bio | text | | バイオグラフィー |
| created_at | timestamptz | | 作成日時 |

#### 4.2.2 events

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | text | PK | イベントID |
| name | text | NOT NULL | イベント名 |
| date | date | NOT NULL | 開催日 |
| date_tbd | boolean | | 日付未確定フラグ |
| date_display | text | | 表示用日付 |
| image_url | text | | 画像URL |
| tier | text | | ティア（S/A/B/C/D/E） |
| format | text | | フォーマット |
| format_type | text | | フォーマットタイプ |
| schedules | jsonb | | 複数日程 |
| viewing_method | text | | 視聴方法 |
| attendance_method | text | | 観覧方法 |
| ticket_urls | jsonb | | チケットURL |
| prize_money | numeric | | 賞金 |
| venue | text | | 開催場所 |
| official_url | text | | 公式URL |
| brand | text | | ブランド名 |
| series_id | text | | シリーズID |
| round | text | | ラウンド名 |
| round_order | integer | | ラウンド順序 |
| performers_confirmed | boolean | | 出演者確定フラグ |
| block_results | jsonb | | ブロック別対戦結果 |
| bio | text | | 説明文 |
| created_at | timestamptz | | 作成日時 |

#### 4.2.3 performances

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | uuid | PK | パフォーマンスID |
| comedian_id | text | FK | 芸人ID |
| event_id | text | FK | イベントID |
| rank | integer | | 順位（null可） |
| score | numeric | | スコア |
| created_at | timestamptz | | 作成日時 |

#### 4.2.4 event_predictions

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | uuid | PK | 予想ID |
| event_id | text | FK | イベントID |
| user_id | uuid | FK | ユーザーID |
| predictions | jsonb | | 予想データ（配列） |
| total_bet_points | integer | | 合計賭けポイント |
| paid_out | boolean | | 払い戻し済みフラグ |
| created_at | timestamptz | | 作成日時 |
| updated_at | timestamptz | | 更新日時 |

#### 4.2.5 user_profiles

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | uuid | PK | プロフィールID |
| user_id | uuid | FK, UNIQUE | ユーザーID |
| balance | integer | | ポイント残高 |
| created_at | timestamptz | | 作成日時 |
| updated_at | timestamptz | | 更新日時 |

#### 4.2.6 user_favorites

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | uuid | PK | お気に入りID |
| user_id | uuid | FK | ユーザーID |
| type | text | | タイプ（comedian/event） |
| target_id | text | | 対象ID |
| created_at | timestamptz | | 作成日時 |

#### 4.2.7 user_preferences

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | uuid | PK | 設定ID |
| user_id | uuid | FK, UNIQUE | ユーザーID |
| theme | text | | テーマ（light/dark） |
| created_at | timestamptz | | 作成日時 |
| updated_at | timestamptz | | 更新日時 |

### 4.3 リレーション

```
comedians (1) ──< performances (N)
events (1) ──< performances (N)
events (1) ──< event_predictions (N)
users (1) ──< event_predictions (N)
users (1) ──< user_profiles (1)
users (1) ──< user_favorites (N)
users (1) ──< user_preferences (1)
```

## 5. セキュリティ設計

### 5.1 認証・認可

**認証方式**:
- Supabase Authによるメール/パスワード認証
- JWTトークンによるセッション管理

**認可**:
- RLS（Row Level Security）によるデータアクセス制御
- ユーザーは自分のデータのみアクセス可能

### 5.2 データ保護

**環境変数**:
- `NEXT_PUBLIC_SUPABASE_URL`: SupabaseプロジェクトURL（クライアントサイドで使用可能）
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`: Supabase匿名キー（クライアントサイドで使用可能）
- `SUPABASE_SERVICE_ROLE_KEY`: Supabaseサービスロールキー（サーバーサイドのみ）
- `GEMINI_API_KEY`: Google Gemini APIキー（サーバーサイドのみ）

**RLSポリシー**:
- `event_predictions`: ユーザーは自分の予想のみ閲覧・編集可能
- `user_profiles`: ユーザーは自分のプロフィールのみ閲覧・編集可能
- `user_favorites`: ユーザーは自分のお気に入りのみ閲覧・編集可能
- `user_preferences`: ユーザーは自分の設定のみ閲覧・編集可能

## 6. エラーハンドリング

### 6.1 エラー種別

**ネットワークエラー**:
- データ取得失敗時のリトライ機能
- エラーメッセージの表示

**認証エラー**:
- ログイン失敗時のエラーメッセージ
- セッション切れ時の自動ログアウト

**データエラー**:
- データ不整合時のフォールバック
- モックデータへのフォールバック

### 6.2 エラー表示

**ユーザー向けメッセージ**:
- わかりやすいエラーメッセージ
- リトライボタンの提供
- サポートへの連絡方法の提示

## 7. パフォーマンス最適化

### 7.1 データ取得最適化

**並列取得**:
- 芸人、イベント、パフォーマンスデータを並列取得

**キャッシュ**:
- ブラウザキャッシュの活用
- データの再取得タイミングの最適化

### 7.2 レンダリング最適化

**Next.js最適化**:
- Server Componentsによる初期レンダリングの最適化
- 自動コード分割
- 画像最適化（Next.js Imageコンポーネント）

**React最適化**:
- `useMemo`による計算結果のメモ化
- `useCallback`による関数のメモ化
- コンポーネントの分割による再レンダリングの最小化
- Client Componentは必要最小限に

**画像最適化**:
- Next.js Imageコンポーネントを使用
- 自動的な遅延読み込み
- WebP形式への自動変換

**アニメーション最適化**:
- anime.jsによる軽量なアニメーション
- transformとopacityを中心に使用
- useEffect内で安全に実行

## 8. レスポンシブデザイン

### 8.1 ブレークポイント

- **モバイル**: < 768px
- **タブレット**: 768px - 1024px
- **デスクトップ**: > 1024px

### 8.2 モバイル対応

**レイアウト変更**:
- サイドバーの非表示
- タブ切り替えの実装
- ボトムシートの使用

**操作最適化**:
- タッチ操作の最適化
- スクロールの最適化

## 9. アクセシビリティ

### 9.1 対応項目

- キーボード操作の対応
- スクリーンリーダー対応（aria-label等）
- コントラスト比の確保
- フォーカス表示の明確化

## 10. ブラウザ対応

### 10.1 対応ブラウザ

- Chrome（最新版）
- Firefox（最新版）
- Safari（最新版）
- Edge（最新版）
- iOS Safari（最新版）
- Chrome Mobile（最新版）
